name: Test Cleanup

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  cleanup:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Remove test deployment
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: deploy
          key: ${{ secrets.DROPLET_SSH_KEY }}
          script: |
            set -e
            cd /opt/apps

            # Check if a test deployment is active
            if [ ! -f test-deploy.active.yml ]; then
              echo "No active test deployment, nothing to clean up."
              exit 0
            fi

            echo "Cleaning up test deployment..."

            # Remove the test config
            rm test-deploy.active.yml

            # Pull latest main
            git pull origin main

            # Regenerate compose without test overlay
            python3 infra/generate-compose.py

            # Redeploy — --remove-orphans drops the test container
            docker compose up -d --remove-orphans

            # Clean up old images
            docker image prune -f

            echo "=== Test cleanup complete ==="

      - name: Delete test image from registry
        continue-on-error: true
        run: |
          # Best-effort cleanup of the :test tag from GHCR
          # This is non-critical — old tags get cleaned up naturally
          echo "Test image cleanup skipped (manual GHCR cleanup if needed)"
