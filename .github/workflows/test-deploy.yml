name: Test Deploy

on:
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  REPO: ${{ github.repository }}

jobs:
  test-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Read test config
        id: config
        run: |
          if [ ! -f test-deploy.yml ]; then
            echo "::error::test-deploy.yml not found on this branch. Add it with an 'app' field to specify which app to test deploy."
            exit 1
          fi

          APP=$(yq '.app' test-deploy.yml)
          if [ -z "$APP" ] || [ "$APP" = "null" ]; then
            echo "::error::No 'app' field found in test-deploy.yml"
            exit 1
          fi

          # Validate the app exists in deploy.yml
          ENABLED=$(yq ".apps.${APP}.enabled" deploy.yml)
          if [ "$ENABLED" = "null" ]; then
            echo "::error::App '${APP}' not found in deploy.yml"
            exit 1
          fi

          # Read subdomain and port so they can be passed to the droplet
          # (the app may not exist in main's deploy.yml yet for new apps)
          SUBDOMAIN=$(yq ".apps.${APP}.subdomain" deploy.yml)
          PORT=$(yq ".apps.${APP}.port // 80" deploy.yml)

          echo "app=${APP}" >> $GITHUB_OUTPUT
          echo "subdomain=${SUBDOMAIN}" >> $GITHUB_OUTPUT
          echo "port=${PORT}" >> $GITHUB_OUTPUT
          echo "Test deploying app: ${APP} (subdomain: ${SUBDOMAIN}, port: ${PORT})"

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push test image
        run: |
          APP="${{ steps.config.outputs.app }}"
          IMAGE=$(echo "${{ env.REGISTRY }}/${{ env.REPO }}/${APP}:test" | tr '[:upper:]' '[:lower:]')
          echo "=== Building ${APP} (test) ==="
          docker build -t "$IMAGE" ./web/${APP}
          docker push "$IMAGE"
          echo "=== Pushed $IMAGE ==="

      - name: Deploy to droplet
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: deploy
          key: ${{ secrets.DROPLET_SSH_KEY }}
          script: |
            set -e
            cd /opt/apps

            # Pull latest main for prod config
            git pull origin main

            TEST_APP="${{ steps.config.outputs.app }}"
            TEST_SUBDOMAIN="${{ steps.config.outputs.subdomain }}"
            TEST_PORT="${{ steps.config.outputs.port }}"

            # Write active test config to the droplet (gitignored runtime file)
            echo "app: ${TEST_APP}" > test-deploy.active.yml

            # If the test app isn't in main's deploy.yml yet (new app still on
            # a feature branch), create a temporary config that includes it so
            # generate-compose.py can build the test overlay. The app is added
            # with enabled: false so no production service is created.
            cp deploy.yml /tmp/deploy-for-test.yml
            python3 -c "
            import yaml
            with open('/tmp/deploy-for-test.yml') as f:
                c = yaml.safe_load(f)
            if '${TEST_APP}' not in c.get('apps', {}):
                c.setdefault('apps', {})['${TEST_APP}'] = {
                    'subdomain': '${TEST_SUBDOMAIN}',
                    'enabled': False,
                    'port': int('${TEST_PORT}'),
                }
                with open('/tmp/deploy-for-test.yml', 'w') as f:
                    yaml.dump(c, f, default_flow_style=False, sort_keys=False)
                print('Added ${TEST_APP} to temp config for test overlay')
            "

            # Login to GHCR
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Generate docker-compose.yml using temp config that includes test app
            CONFIG_PATH=/tmp/deploy-for-test.yml python3 infra/generate-compose.py

            # Pull latest images and deploy
            docker compose pull
            docker compose up -d --remove-orphans

            # Clean up old images
            docker image prune -f

            echo "=== Test deployment complete ==="
